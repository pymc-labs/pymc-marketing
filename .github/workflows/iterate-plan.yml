name: Claude Code Iterate Plan

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: claude-iterate-plan-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  iterate_plan:
    if: contains(github.event.issue.labels.*.name, 'iterate_plan')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Gather feedback from comments
        id: extract_feedback
        run: |
          # Fetch all comments on the issue, excluding github-actions bot comments
          gh api "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            --jq '.[] | select(.user.login != "github-actions[bot]") | "### Comment by @\(.user.login) at \(.created_at)\n\n\(.body)\n\n---\n"' \
            > /tmp/all_comments.txt || echo "No comments found" > /tmp/all_comments.txt

          # Use heredoc to safely handle multiline content with special characters
          {
            echo "feedback<<EOF_FEEDBACK"
            cat /tmp/all_comments.txt
            echo "EOF_FEEDBACK"
          } >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find plan file
        id: find_plan
        run: |
          issue_number="${{ github.event.issue.number }}"
          plan_file="thoughts/shared/issues/${issue_number}/plan.md"

          if [ ! -f "$plan_file" ]; then
            echo "âŒ No plan file found at $plan_file"
            echo "Please create a plan first with /plan"
            exit 1
          fi

          echo "plan_file=$plan_file" >> $GITHUB_OUTPUT
          echo "âœ… Found plan: $plan_file"

      - name: Run iteration command
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          feedback="${{ steps.extract_feedback.outputs.feedback }}"
          plan_file="${{ steps.find_plan.outputs.plan_file }}"

          cat > /tmp/iteration_prompt.txt << 'HEADER'
          Update the implementation plan based on all comments and feedback:

          ## Comments/Feedback from Issue

          HEADER

          echo "$feedback" >> /tmp/iteration_prompt.txt
          echo "" >> /tmp/iteration_prompt.txt
          echo "---" >> /tmp/iteration_prompt.txt
          echo "" >> /tmp/iteration_prompt.txt
          echo "## Current Document" >> /tmp/iteration_prompt.txt
          cat "$plan_file" >> /tmp/iteration_prompt.txt

          claude -p \
            --dangerously-skip-permissions \
            --max-turns 200 \
            --verbose \
            "/create_plan_issue @/tmp/iteration_prompt.txt" 2>&1 | tee /tmp/claude_output.log

      - name: Find and update existing plan comment
        id: find_comment
        run: |
          # Find the most recent plan comment (either initial or updated)
          comment_id=$(gh api \
            "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            --jq '.[] | select(.body | startswith("## ðŸ“‹ Implementation Plan") or startswith("## ðŸ”„ Plan Updated")) | .id' \
            | tail -1)

          echo "comment_id=$comment_id" >> $GITHUB_OUTPUT

          if [ -n "$comment_id" ]; then
            echo "âœ… Found existing plan comment: $comment_id"
          else
            echo "â„¹ï¸ No existing plan comment found, will create new one"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Post updated plan
        run: |
          plan_file="${{ steps.find_plan.outputs.plan_file }}"
          comment_id="${{ steps.find_comment.outputs.comment_id }}"

          cat > /tmp/comment.md << 'HEADER'
          ## ðŸ”„ Plan Updated

          The implementation plan has been updated based on your feedback.

          <details>
          <summary>Click to expand plan</summary>

          ---

          HEADER

          cat "$plan_file" >> /tmp/comment.md

          echo "" >> /tmp/comment.md
          echo "</details>" >> /tmp/comment.md

          if [ -n "$comment_id" ]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/issues/comments/$comment_id" \
              -f body="$(cat /tmp/comment.md)"
            echo "âœ… Updated existing comment #$comment_id"
          else
            # Create new comment
            gh issue comment ${{ github.event.issue.number }} \
              --body-file /tmp/comment.md
            echo "âœ… Created new comment"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Commit updated plan
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add thoughts/shared/issues/${{ github.event.issue.number }}/

          if ! git diff --staged --quiet; then
            git commit -m "Update plan for issue #${{ github.event.issue.number }}"
            git push
          fi

      - name: Update labels
        if: success()
        run: |
          # Remove iterate_plan label after completion
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "iterate_plan"

          echo "âœ… Updated labels"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-output-iterate-plan-${{ github.event.issue.number }}
          path: /tmp/claude_output.log
          retention-days: 7

      - name: Handle errors
        if: failure()
        run: |
          cat > /tmp/error.md << 'EOF'
          ## âŒ Plan Iteration Failed

          The `/iterate_plan` workflow encountered an error.

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          **Common issues**:
          - No plan file exists for this issue (create a plan first)
          - API errors or timeouts
          EOF

          gh issue comment ${{ github.event.issue.number }} \
            --body-file /tmp/error.md || true
        env:
          GH_TOKEN: ${{ github.token }}
