name: Claude Code Planning

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: claude-plan-${{ github.event.issue.number }}
  cancel-in-progress: false # Don't cancel running plans

jobs:
  plan:
    # Only run if issue has plan_needed label
    if: contains(github.event.issue.labels.*.name, 'plan_needed')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Verify Claude installation
        run: |
          claude --version

      - name: Create issue prompt file
        run: |
          # Start with issue title and body
          cat > /tmp/issue_prompt.txt << 'EOF'
          # Issue: ${{ github.event.issue.title }}

          ${{ github.event.issue.body }}
          EOF

          # Fetch and append all comments
          echo "" >> /tmp/issue_prompt.txt
          echo "---" >> /tmp/issue_prompt.txt
          echo "" >> /tmp/issue_prompt.txt
          echo "## Comments" >> /tmp/issue_prompt.txt
          echo "" >> /tmp/issue_prompt.txt

          gh api "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            --jq '.[] | "### Comment by @\(.user.login) at \(.created_at)\n\n\(.body)\n\n---\n"' \
            >> /tmp/issue_prompt.txt || echo "No comments found" >> /tmp/issue_prompt.txt

          echo "Issue prompt with comments saved to /tmp/issue_prompt.txt"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find research context
        id: find_research_context
        run: |
          issue_number="${{ github.event.issue.number }}"
          research_file="thoughts/shared/issues/${issue_number}/research.md"

          if [ -f "$research_file" ]; then
            echo "Found research for issue #${issue_number}: $research_file"
            echo "research_file=$research_file" >> $GITHUB_OUTPUT
            echo "has_research=true" >> $GITHUB_OUTPUT

            cp "$research_file" /tmp/research_context.md
            echo "âœ… Will include research context in planning"
          else
            echo "No research file found for issue #${issue_number}"
            echo "has_research=false" >> $GITHUB_OUTPUT
          fi

      - name: Run plan command
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          issue_number="${{ github.event.issue.number }}"
          issue_dir="thoughts/shared/issues/${issue_number}"

          # Create issue directory
          mkdir -p "$issue_dir"

          echo "Starting planning for issue #${issue_number}"
          echo "Output will be: ${issue_dir}/plan.md"

          claude -p \
            --dangerously-skip-permissions \
            --max-turns 200 \
            --verbose \
            "/create_plan_issue $(cat /tmp/issue_prompt.txt)" 2>&1 | tee /tmp/claude_output.log

          echo "Plan command completed"

      - name: Find plan output
        id: find_plan
        run: |
          issue_number="${{ github.event.issue.number }}"
          plan_file="thoughts/shared/issues/${issue_number}/plan.md"

          if [ ! -f "$plan_file" ]; then
            echo "error=No plan file found at $plan_file" >> $GITHUB_OUTPUT
            echo "âŒ No plan file generated"
            exit 1
          fi

          echo "plan_file=$plan_file" >> $GITHUB_OUTPUT
          echo "âœ… Found plan: $plan_file"

          echo "Preview:"
          head -20 "$plan_file"

      - name: Post plan to issue
        if: steps.find_plan.outputs.plan_file != ''
        run: |
          plan_file="${{ steps.find_plan.outputs.plan_file }}"

          # Check file size (GitHub comment limit is 65536 characters)
          file_size=$(wc -c < "$plan_file")
          echo "Plan file size: $file_size bytes"

          # Create comment with header and collapsible plan
          cat > /tmp/plan_comment.md << 'HEADER'
          ## ðŸ“‹ Implementation Plan

          Generated by Claude Code in response to `plan_needed` label.

          <details>
          <summary>Click to expand plan</summary>

          ---

          HEADER

          cat "$plan_file" >> /tmp/plan_comment.md

          echo "" >> /tmp/plan_comment.md
          echo "</details>" >> /tmp/plan_comment.md

          # Create comment with plan
          gh issue comment ${{ github.event.issue.number }} \
            --body-file /tmp/plan_comment.md

          echo "âœ… Posted plan to issue #${{ github.event.issue.number }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update labels
        if: success()
        run: |
          # Remove plan_needed, add plan_complete
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "plan_needed" \
            --add-label "plan_complete"

          echo "âœ… Updated labels"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Commit plan file
        if: steps.find_plan.outputs.plan_file != ''
        run: |
          issue_number="${{ github.event.issue.number }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "thoughts/shared/issues/${issue_number}/"

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add plan for issue #${issue_number}"
            git push
            echo "âœ… Committed and pushed plan file"
          fi

      - name: Upload Claude output logs
        if: always() # Run even on failure
        uses: actions/upload-artifact@v4
        with:
          name: claude-output-issue-${{ github.event.issue.number }}
          path: /tmp/claude_output.log
          retention-days: 7

      - name: Handle errors
        if: failure()
        run: |
          # Post error comment to issue
          cat > /tmp/error_comment.md << 'EOF'
          ## âŒ Planning Workflow Failed

          The Claude Code planning workflow encountered an error.

          **Issue**: #${{ github.event.issue.number }}
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please check the workflow logs for details.
          EOF

          gh issue comment ${{ github.event.issue.number }} \
            --body-file /tmp/error_comment.md || true

          echo "Posted error comment to issue"
        env:
          GH_TOKEN: ${{ github.token }}
