name: Claude Code Research

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: claude-research-${{ github.event.issue.number }}
  cancel-in-progress: false # Don't cancel running research

jobs:
  research:
    # Only run if issue has research_needed label
    if: contains(github.event.issue.labels.*.name, 'research_needed')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write # For git commits
      issues: write # For comments and labels

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git metadata

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Verify Claude installation
        run: |
          claude --version

      - name: Create issue prompt file
        run: |
          # Start with issue title and body
          cat > /tmp/issue_prompt.txt << 'EOF'
          # Issue: ${{ github.event.issue.title }}

          ${{ github.event.issue.body }}
          EOF

          # Fetch and append all comments
          echo "" >> /tmp/issue_prompt.txt
          echo "---" >> /tmp/issue_prompt.txt
          echo "" >> /tmp/issue_prompt.txt
          echo "## Comments" >> /tmp/issue_prompt.txt
          echo "" >> /tmp/issue_prompt.txt

          gh api "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            --jq '.[] | "### Comment by @\(.user.login) at \(.created_at)\n\n\(.body)\n\n---\n"' \
            >> /tmp/issue_prompt.txt || echo "No comments found" >> /tmp/issue_prompt.txt

          echo "Issue prompt with comments saved to /tmp/issue_prompt.txt"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run research command
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          issue_number="${{ github.event.issue.number }}"
          issue_dir="thoughts/shared/issues/${issue_number}"

          # Create issue directory
          mkdir -p "$issue_dir"

          echo "Starting research for issue #${issue_number}"
          echo "Output will be: ${issue_dir}/research.md"

          claude -p \
            --dangerously-skip-permissions \
            --max-turns 200 \
            --verbose \
            "/research_codebase_issue $(cat /tmp/issue_prompt.txt)" 2>&1 | tee /tmp/claude_output.log

          echo "Research command completed"

      - name: Find research output
        id: find_research
        run: |
          issue_number="${{ github.event.issue.number }}"
          research_file="thoughts/shared/issues/${issue_number}/research.md"

          if [ ! -f "$research_file" ]; then
            echo "error=No research file found at $research_file" >> $GITHUB_OUTPUT
            echo "âŒ No research file generated"
            exit 1
          fi

          echo "research_file=$research_file" >> $GITHUB_OUTPUT
          echo "âœ… Found research: $research_file"

          echo "Preview:"
          head -20 "$research_file"

      - name: Post research to issue
        if: steps.find_research.outputs.research_file != ''
        run: |
          research_file="${{ steps.find_research.outputs.research_file }}"

          # Check file size (GitHub comment limit is 65536 characters)
          file_size=$(wc -c < "$research_file")
          echo "Research file size: $file_size bytes"

          # Create comment with header and collapsible research
          cat > /tmp/research_comment.md << 'HEADER'
          ## ðŸ“‹ Research

          Generated by Claude Code in response to `research_needed` label.

          <details>
          <summary>Click to expand research</summary>

          ---

          HEADER

          cat "$research_file" >> /tmp/research_comment.md

          echo "" >> /tmp/research_comment.md
          echo "</details>" >> /tmp/research_comment.md

          # Create comment with research
          gh issue comment ${{ github.event.issue.number }} \
            --body-file /tmp/research_comment.md

          echo "âœ… Posted research to issue #${{ github.event.issue.number }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update labels
        if: success()
        run: |
          # Remove research_needed, add research_complete
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "research_needed" \
            --add-label "research_complete"

          echo "âœ… Updated labels"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Commit research file
        if: steps.find_research.outputs.research_file != ''
        run: |
          issue_number="${{ github.event.issue.number }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "thoughts/shared/issues/${issue_number}/"

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add research for issue #${issue_number}"
            git push
            echo "âœ… Committed and pushed research file"
          fi

      - name: Upload Claude output logs
        if: always() # Run even on failure
        uses: actions/upload-artifact@v4
        with:
          name: claude-output-issue-${{ github.event.issue.number }}
          path: /tmp/claude_output.log
          retention-days: 7

      - name: Handle errors
        if: failure()
        run: |
          # Post error comment to issue
          cat > /tmp/error_comment.md << 'EOF'
          ## âŒ Research Workflow Failed

          The Claude Code research workflow encountered an error.

          **Issue**: #${{ github.event.issue.number }}
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please check the workflow logs for details.
          EOF

          gh issue comment ${{ github.event.issue.number }} \
            --body-file /tmp/error_comment.md || true

          echo "Posted error comment to issue"
        env:
          GH_TOKEN: ${{ github.token }}
